unit module Encoding::Huffman::PP6;

my %huffman-http2 = 
  0.chr => "1111111111000",
  1.chr => "11111111111111111011000",
  2.chr => "1111111111111111111111100010",
  3.chr => "1111111111111111111111100011",
  4.chr => "1111111111111111111111100100",
  5.chr => "1111111111111111111111100101",
  6.chr => "1111111111111111111111100110",
  7.chr => "1111111111111111111111100111",
  8.chr => "1111111111111111111111101000",
  9.chr => "111111111111111111101010",
  10.chr => "111111111111111111111111111100",
  11.chr => "1111111111111111111111101001",
  12.chr => "1111111111111111111111101010",
  13.chr => "111111111111111111111111111101",
  14.chr => "1111111111111111111111101011",
  15.chr => "1111111111111111111111101100",
  16.chr => "1111111111111111111111101101",
  17.chr => "1111111111111111111111101110",
  18.chr => "1111111111111111111111101111",
  19.chr => "1111111111111111111111110000",
  20.chr => "1111111111111111111111110001",
  21.chr => "1111111111111111111111110010",
  22.chr => "111111111111111111111111111110",
  23.chr => "1111111111111111111111110011",
  24.chr => "1111111111111111111111110100",
  25.chr => "1111111111111111111111110101",
  26.chr => "1111111111111111111111110110",
  27.chr => "1111111111111111111111110111",
  28.chr => "1111111111111111111111111000",
  29.chr => "1111111111111111111111111001",
  30.chr => "1111111111111111111111111010",
  31.chr => "1111111111111111111111111011",
  32.chr => "010100",
  33.chr => "1111111000",
  34.chr => "1111111001",
  35.chr => "111111111010",
  36.chr => "1111111111001",
  37.chr => "010101",
  38.chr => "11111000",
  39.chr => "11111111010",
  40.chr => "1111111010",
  41.chr => "1111111011",
  42.chr => "11111001",
  43.chr => "11111111011",
  44.chr => "11111010",
  45.chr => "010110",
  46.chr => "010111",
  47.chr => "011000",
  48.chr => "00000",
  49.chr => "00001",
  50.chr => "00010",
  51.chr => "011001",
  52.chr => "011010",
  53.chr => "011011",
  54.chr => "011100",
  55.chr => "011101",
  56.chr => "011110",
  57.chr => "011111",
  58.chr => "1011100",
  59.chr => "11111011",
  60.chr => "111111111111100",
  61.chr => "100000",
  62.chr => "111111111011",
  63.chr => "1111111100",
  64.chr => "1111111111010",
  65.chr => "100001",
  66.chr => "1011101",
  67.chr => "1011110",
  68.chr => "1011111",
  69.chr => "1100000",
  70.chr => "1100001",
  71.chr => "1100010",
  72.chr => "1100011",
  73.chr => "1100100",
  74.chr => "1100101",
  75.chr => "1100110",
  76.chr => "1100111",
  77.chr => "1101000",
  78.chr => "1101001",
  79.chr => "1101010",
  80.chr => "1101011",
  81.chr => "1101100",
  82.chr => "1101101",
  83.chr => "1101110",
  84.chr => "1101111",
  85.chr => "1110000",
  86.chr => "1110001",
  87.chr => "1110010",
  88.chr => "11111100",
  89.chr => "1110011",
  90.chr => "11111101",
  91.chr => "1111111111011",
  92.chr => "1111111111111110000",
  93.chr => "1111111111100",
  94.chr => "11111111111100",
  95.chr => "100010",
  96.chr => "111111111111101",
  97.chr => "00011",
  98.chr => "100011",
  99.chr => "00100",
  100.chr => "100100",
  101.chr => "00101",
  102.chr => "100101",
  103.chr => "100110",
  104.chr => "100111",
  105.chr => "00110",
  106.chr => "1110100",
  107.chr => "1110101",
  108.chr => "101000",
  109.chr => "101001",
  110.chr => "101010",
  111.chr => "00111",
  112.chr => "101011",
  113.chr => "1110110",
  114.chr => "101100",
  115.chr => "01000",
  116.chr => "01001",
  117.chr => "101101",
  118.chr => "1110111",
  119.chr => "1111000",
  120.chr => "1111001",
  121.chr => "1111010",
  122.chr => "1111011",
  123.chr => "111111111111110",
  124.chr => "11111111100",
  125.chr => "11111111111101",
  126.chr => "1111111111101",
  127.chr => "1111111111111111111111111100",
  128.chr => "11111111111111100110",
  129.chr => "1111111111111111010010",
  130.chr => "11111111111111100111",
  131.chr => "11111111111111101000",
  132.chr => "1111111111111111010011",
  133.chr => "1111111111111111010100",
  134.chr => "1111111111111111010101",
  135.chr => "11111111111111111011001",
  136.chr => "1111111111111111010110",
  137.chr => "11111111111111111011010",
  138.chr => "11111111111111111011011",
  139.chr => "11111111111111111011100",
  140.chr => "11111111111111111011101",
  141.chr => "11111111111111111011110",
  142.chr => "111111111111111111101011",
  143.chr => "11111111111111111011111",
  144.chr => "111111111111111111101100",
  145.chr => "111111111111111111101101",
  146.chr => "1111111111111111010111",
  147.chr => "11111111111111111100000",
  148.chr => "111111111111111111101110",
  149.chr => "11111111111111111100001",
  150.chr => "11111111111111111100010",
  151.chr => "11111111111111111100011",
  152.chr => "11111111111111111100100",
  153.chr => "111111111111111011100",
  154.chr => "1111111111111111011000",
  155.chr => "11111111111111111100101",
  156.chr => "1111111111111111011001",
  157.chr => "11111111111111111100110",
  158.chr => "11111111111111111100111",
  159.chr => "111111111111111111101111",
  160.chr => "1111111111111111011010",
  161.chr => "111111111111111011101",
  162.chr => "11111111111111101001",
  163.chr => "1111111111111111011011",
  164.chr => "1111111111111111011100",
  165.chr => "11111111111111111101000",
  166.chr => "11111111111111111101001",
  167.chr => "111111111111111011110",
  168.chr => "11111111111111111101010",
  169.chr => "1111111111111111011101",
  170.chr => "1111111111111111011110",
  171.chr => "111111111111111111110000",
  172.chr => "111111111111111011111",
  173.chr => "1111111111111111011111",
  174.chr => "11111111111111111101011",
  175.chr => "11111111111111111101100",
  176.chr => "111111111111111100000",
  177.chr => "111111111111111100001",
  178.chr => "1111111111111111100000",
  179.chr => "111111111111111100010",
  180.chr => "11111111111111111101101",
  181.chr => "1111111111111111100001",
  182.chr => "11111111111111111101110",
  183.chr => "11111111111111111101111",
  184.chr => "11111111111111101010",
  185.chr => "1111111111111111100010",
  186.chr => "1111111111111111100011",
  187.chr => "1111111111111111100100",
  188.chr => "11111111111111111110000",
  189.chr => "1111111111111111100101",
  190.chr => "1111111111111111100110",
  191.chr => "11111111111111111110001",
  192.chr => "11111111111111111111100000",
  193.chr => "11111111111111111111100001",
  194.chr => "11111111111111101011",
  195.chr => "1111111111111110001",
  196.chr => "1111111111111111100111",
  197.chr => "11111111111111111110010",
  198.chr => "1111111111111111101000",
  199.chr => "1111111111111111111101100",
  200.chr => "11111111111111111111100010",
  201.chr => "11111111111111111111100011",
  202.chr => "11111111111111111111100100",
  203.chr => "111111111111111111111011110",
  204.chr => "111111111111111111111011111",
  205.chr => "11111111111111111111100101",
  206.chr => "111111111111111111110001",
  207.chr => "1111111111111111111101101",
  208.chr => "1111111111111110010",
  209.chr => "111111111111111100011",
  210.chr => "11111111111111111111100110",
  211.chr => "111111111111111111111100000",
  212.chr => "111111111111111111111100001",
  213.chr => "11111111111111111111100111",
  214.chr => "111111111111111111111100010",
  215.chr => "111111111111111111110010",
  216.chr => "111111111111111100100",
  217.chr => "111111111111111100101",
  218.chr => "11111111111111111111101000",
  219.chr => "11111111111111111111101001",
  220.chr => "1111111111111111111111111101",
  221.chr => "111111111111111111111100011",
  222.chr => "111111111111111111111100100",
  223.chr => "111111111111111111111100101",
  224.chr => "11111111111111101100",
  225.chr => "111111111111111111110011",
  226.chr => "11111111111111101101",
  227.chr => "111111111111111100110",
  228.chr => "1111111111111111101001",
  229.chr => "111111111111111100111",
  230.chr => "111111111111111101000",
  231.chr => "11111111111111111110011",
  232.chr => "1111111111111111101010",
  233.chr => "1111111111111111101011",
  234.chr => "1111111111111111111101110",
  235.chr => "1111111111111111111101111",
  236.chr => "111111111111111111110100",
  237.chr => "111111111111111111110101",
  238.chr => "11111111111111111111101010",
  239.chr => "11111111111111111110100",
  240.chr => "11111111111111111111101011",
  241.chr => "111111111111111111111100110",
  242.chr => "11111111111111111111101100",
  243.chr => "11111111111111111111101101",
  244.chr => "111111111111111111111100111",
  245.chr => "111111111111111111111101000",
  246.chr => "111111111111111111111101001",
  247.chr => "111111111111111111111101010",
  248.chr => "111111111111111111111101011",
  249.chr => "1111111111111111111111111110",
  250.chr => "111111111111111111111101100",
  251.chr => "111111111111111111111101101",
  252.chr => "111111111111111111111101110",
  253.chr => "111111111111111111111101111",
  254.chr => "111111111111111111111110000",
  255.chr => "11111111111111111111101110",
  _eos => "111111111111111111111111111111",
;

sub huffman-encode(Str $s, %codes = %huffman-http2) is export {
  my     $bits = $s.comb.map({ %codes{$_}.Str }).join('');
  my Buf[uint8] $enc .=new((0..($bits.codes/8).ceiling).map({ 0 }));
  my Int $i    = 0;
  for ($bits.comb, %codes<_eos>.comb).flat -> $c {
    $enc[($i / 8).floor] +|= do given $i mod 8 {
      when 0 { 0x80 };
      when 1 { 0x40 };
      when 2 { 0x20 };
      when 3 { 0x10 };
      when 4 { 0x08 };
      when 5 { 0x04 };
      when 6 { 0x02 };
      when 7 { 0x01 };
    } if $c eq '1';
    $i++;
  }
  return $enc;
}

sub huffman-decode(Buf[uint8] $s, %codes = %huffman-http2) is export {
  my Str $r = '';
  my Str $a = '';
  my %a = %codes.keys.map({ %codes{$_} => $_; });
  for $s.map({ .base(2).Str.comb }) -> @i {
    for ((@i.elems == 8 ?? [] !! 0..(7-@i.elems)).map({'0'}), |@i).flat -> $c {
      $a ~= $c;
      next unless %a{$a}.defined;
      last if %a{$a} eq '_eos';
      $r ~= try {%a{$a}.chr} // %a{$a};
      $a  = '';
    }
  }
  return $r;
}

# vi:syntax=perl6
